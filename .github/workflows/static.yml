# Simple workflow for deploying static content to GitHub Pages
name: Deploy Pages (Production)

on:
  # Runs on pushes targeting the default branch
  push:
    branches: ["main"]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Single deploy job since we're just deploying
  deploy:
    environment:
      name: github-pages
      url: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: webpage/package-lock.json

      - name: Install dependencies
        working-directory: webpage
        run: npm ci

      - name: Fetch Repo Commit Data
        run: |
          echo "Fetching commits for ${{ github.repository }}..."
          curl -L \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ github.repository }}/commits?per_page=100" \
            -o commits-data.json

          echo "Generating webpage/src/data/commitStats.ts..."
          node -e '
            const fs = require("fs");

            function writeCommitStats(stats) {
              const header = "// Auto-generated during GitHub Pages deploy\n";
              const body = "export const commitStats: Record<string, number> = " + JSON.stringify(stats, null, 2) + ";\n";
              fs.writeFileSync("webpage/src/data/commitStats.ts", header + body);
            }

            try {
              const commits = JSON.parse(fs.readFileSync("commits-data.json", "utf8"));
              const commitCounts = {};

              for (const commit of commits) {
                const username = commit?.author?.login;
                if (!username) continue;
                commitCounts[username] = (commitCounts[username] || 0) + 1;
              }

              console.log("Commit counts by username:", commitCounts);
              writeCommitStats(commitCounts);
            } catch (error) {
              console.error("Error processing commits:", error);
              writeCommitStats({});
            }
          '
      - name: Test
        working-directory: webpage
        run: npm run coverage
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: webpage/coverage
      - name: Build
        working-directory: webpage
        env:
          BASE_PATH: /${{ github.event.repository.name }}/
        run: npm run build

      - name: Deploy production (gh-pages)
        run: |
          set -euo pipefail

          PROD_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo "Production URL: ${PROD_URL}" >> "$GITHUB_STEP_SUMMARY"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          WORKTREE_DIR=".gh-pages-worktree"
          rm -rf "${WORKTREE_DIR}"

          # If gh-pages exists, fetch it into a local branch; otherwise create it.
          if git ls-remote --exit-code --heads origin gh-pages >/dev/null 2>&1; then
            git fetch origin gh-pages:gh-pages
            git worktree add -B gh-pages "${WORKTREE_DIR}" gh-pages
          else
            git worktree add "${WORKTREE_DIR}" --detach
            cd "${WORKTREE_DIR}"
            git switch --orphan gh-pages
            git rm -rf . || true
            cd - >/dev/null
          fi

          # Sync dist/ into the branch root, but preserve all PR previews under pr/
          rsync -a --delete --exclude 'pr/' "webpage/dist/" "${WORKTREE_DIR}/"
          touch "${WORKTREE_DIR}/.nojekyll"

          cd "${WORKTREE_DIR}"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to deploy."
            exit 0
          fi

          git commit -m "Deploy production"
          git push origin gh-pages
          cd - >/dev/null

          git worktree remove "${WORKTREE_DIR}" --force