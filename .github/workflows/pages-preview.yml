name: Preview Pages Deploy

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - "webpage/**"
      - "docs/**"
      - ".github/workflows/static.yml"
      - ".github/workflows/pages-preview.yml"
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages-preview-${{ github.event.pull_request.number || github.ref }}"
  cancel-in-progress: true

jobs:
  preview:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: webpage/package-lock.json

      - name: Install dependencies
        working-directory: webpage
        run: npm ci

      - name: Fetch Repo Commit Data
        run: |
          echo "Fetching commits for ${{ github.repository }}..."
          curl -L \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ github.repository }}/commits?per_page=100" \
            -o commits-data.json

          echo "Generating webpage/src/data/commitStats.ts..."
          node -e '
            const fs = require("fs");

            function writeCommitStats(stats) {
              const header = "// Auto-generated during GitHub Pages deploy\n";
              const body = "export const commitStats: Record<string, number> = " + JSON.stringify(stats, null, 2) + ";\n";
              fs.writeFileSync("webpage/src/data/commitStats.ts", header + body);
            }

            try {
              const commits = JSON.parse(fs.readFileSync("commits-data.json", "utf8"));
              const commitCounts = {};

              for (const commit of commits) {
                const username = commit?.author?.login;
                if (!username) continue;
                commitCounts[username] = (commitCounts[username] || 0) + 1;
              }

              console.log("Commit counts by username:", commitCounts);
              writeCommitStats(commitCounts);
            } catch (error) {
              console.error("Error processing commits:", error);
              writeCommitStats({});
            }
          '

      - name: Test
        working-directory: webpage
        run: npm run coverage

      - name: Build
        working-directory: webpage
        env:
          BASE_PATH: /${{ github.event.repository.name }}/
        run: npm run build

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: webpage/dist

      - name: Deploy preview to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          preview: true
