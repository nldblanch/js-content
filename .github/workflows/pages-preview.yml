name: Preview Pages Deploy

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - "webpage/**"
      - "docs/**"
      - ".github/workflows/static.yml"
      - ".github/workflows/pages-preview.yml"
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to publish under /pr/<number>/ (manual runs only)"
        required: true
        type: string

permissions:
  contents: write

concurrency:
  group: "pages-preview-${{ github.event.pull_request.number || github.ref }}"
  cancel-in-progress: true

jobs:
  preview:
    runs-on: ubuntu-latest
    # Fork PRs don't have permission to push to gh-pages
    if: github.event_name == 'workflow_dispatch' || github.event.pull_request.head.repo.full_name == github.repository
    env:
      PR_NUMBER: ${{ github.event.pull_request.number || inputs.pr_number }}
    environment:
      name: testing
      url: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/pr/${{ env.PR_NUMBER }}/

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: webpage/package-lock.json

      - name: Install dependencies
        working-directory: webpage
        run: npm ci

      - name: Fetch Repo Commit Data
        run: |
          echo "Fetching commits for ${{ github.repository }}..."
          curl -L \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ github.repository }}/commits?per_page=100" \
            -o commits-data.json

          echo "Generating webpage/src/data/commitStats.ts..."
          node -e '
            const fs = require("fs");

            function writeCommitStats(stats) {
              const header = "// Auto-generated during GitHub Pages deploy\n";
              const body = "export const commitStats: Record<string, number> = " + JSON.stringify(stats, null, 2) + ";\n";
              fs.writeFileSync("webpage/src/data/commitStats.ts", header + body);
            }

            try {
              const commits = JSON.parse(fs.readFileSync("commits-data.json", "utf8"));
              const commitCounts = {};

              for (const commit of commits) {
                const username = commit?.author?.login;
                if (!username) continue;
                commitCounts[username] = (commitCounts[username] || 0) + 1;
              }

              console.log("Commit counts by username:", commitCounts);
              writeCommitStats(commitCounts);
            } catch (error) {
              console.error("Error processing commits:", error);
              writeCommitStats({});
            }
          '

      - name: Test
        working-directory: webpage
        run: npm run coverage

      - name: Build
        working-directory: webpage
        env:
          BASE_PATH: /${{ github.event.repository.name }}/pr/${{ env.PR_NUMBER }}/
        run: npm run build

      - name: Deploy PR preview (gh-pages)
        run: |
          set -euo pipefail

          PREVIEW_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/pr/${PR_NUMBER}/"
          echo "Preview URL: ${PREVIEW_URL}" >> "$GITHUB_STEP_SUMMARY"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          WORKTREE_DIR=".gh-pages-worktree"
          rm -rf "${WORKTREE_DIR}"

          # Safety: don't allow PR previews to be the first thing that creates gh-pages,
          # because that would effectively wipe the production site.
          if ! git fetch origin gh-pages:gh-pages; then
            echo "Unable to fetch gh-pages. Ensure the production workflow has created it, and that GITHUB_TOKEN has write access." >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi
          git worktree add -B gh-pages "${WORKTREE_DIR}" gh-pages

          mkdir -p "${WORKTREE_DIR}/pr/${PR_NUMBER}"
          rsync -a --delete "webpage/dist/" "${WORKTREE_DIR}/pr/${PR_NUMBER}/"
          touch "${WORKTREE_DIR}/.nojekyll"

          cd "${WORKTREE_DIR}"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to deploy."
            exit 0
          fi

          git commit -m "Deploy PR preview: #${PR_NUMBER}"
          git push origin gh-pages
          cd - >/dev/null

          git worktree remove "${WORKTREE_DIR}" --force
